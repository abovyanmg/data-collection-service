name: Build and Push Docker Images

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'  # –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ git —Ç–µ–≥–∏ —Ñ–æ—Ä–º–∞—Ç–∞ v1.0.0
  pull_request:
    branches: [ main ]
  schedule:
    # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

env:
  REGISTRY: docker.io
  UPLOAD_DATA_IMAGE: abovyanmg/upload_data
  CLICKHOUSE_IMAGE: abovyanmg/clickhouse

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Generate version tags
      id: version
      run: |
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ git —Ç–µ–≥–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}  # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 'v' –µ—Å–ª–∏ –µ—Å—Ç—å
          IS_RELEASE=true
        else
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ –¥–∞—Ç—ã –∏ –∫–æ–º–º–∏—Ç–∞
          VERSION="$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          IS_RELEASE=false
        fi
        
        # –î–ª—è main –≤–µ—Ç–∫–∏ —Å–æ–∑–¥–∞–µ–º stable —Ç–µ–≥
        if [[ "${{ github.ref }}" == refs/heads/main ]]; then
          STABLE_TAG="stable"
        else
          STABLE_TAG=""
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
        echo "stable_tag=$STABLE_TAG" >> $GITHUB_OUTPUT
        echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
        
        echo "üì¶ Generated version: $VERSION"
        echo "üè∑Ô∏è  Is release: $IS_RELEASE"
        echo "üîñ Stable tag: $STABLE_TAG"
    
    - name: Build and push upload_data
      id: build_upload_data
      uses: docker/build-push-action@v5
      with:
        context: ./admin
        file: ./admin/docker/Dockerfile.upload_data
        push: true
        tags: |
          ${{ env.UPLOAD_DATA_IMAGE }}:latest
          ${{ env.UPLOAD_DATA_IMAGE }}:${{ steps.version.outputs.version }}
          ${{ env.UPLOAD_DATA_IMAGE }}:${{ steps.version.outputs.stable_tag }}
          ${{ env.UPLOAD_DATA_IMAGE }}:${{ steps.version.outputs.short_sha }}
        labels: |
          org.opencontainers.image.title=ACS Data Collection Service
          org.opencontainers.image.description=Professional data collection from marketplaces to ClickHouse
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push clickhouse
      id: build_clickhouse
      uses: docker/build-push-action@v5
      with:
        context: ./admin/docker
        file: ./admin/docker/Dockerfile.clickhouse
        push: true
        tags: |
          ${{ env.CLICKHOUSE_IMAGE }}:latest
          ${{ env.CLICKHOUSE_IMAGE }}:${{ steps.version.outputs.version }}
          ${{ env.CLICKHOUSE_IMAGE }}:${{ steps.version.outputs.stable_tag }}
          ${{ env.CLICKHOUSE_IMAGE }}:${{ steps.version.outputs.short_sha }}
        labels: |
          org.opencontainers.image.title=ACS ClickHouse
          org.opencontainers.image.description=ClickHouse database for ACS Data Collection Service
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Image digests
      run: |
        echo "‚úÖ Docker –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã!"
        echo "üì¶ upload_data:latest"
        echo "üì¶ upload_data:${{ steps.version.outputs.version }}"
        echo "üì¶ upload_data:${{ steps.version.outputs.stable_tag }}"
        echo "üì¶ upload_data:${{ steps.version.outputs.short_sha }}"
        echo "üì¶ clickhouse:latest"
        echo "üì¶ clickhouse:${{ steps.version.outputs.version }}"
        echo "üì¶ clickhouse:${{ steps.version.outputs.stable_tag }}"
        echo "üì¶ clickhouse:${{ steps.version.outputs.short_sha }}"
        echo "üåê https://hub.docker.com/u/abovyanmg"
        echo ""
        echo "üîñ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–µ–≥: stable"
        echo "üîñ –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–µ–≥: ${{ steps.version.outputs.version }}"
